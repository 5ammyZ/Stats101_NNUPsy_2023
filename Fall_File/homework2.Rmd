---
title: "小作业"
output: html_document
date: "2023-09-19"
---

# 题目

模拟三种教学方案对学生成绩的影响并分别使用t检验和F检验检验这种影响。假设采用教学方案1的学生成绩服从均值为50，标准差为15的正态分布；采用教学方案2的学生成绩服从均值为60，标准差为10的正态分布；采用教学方案3的学生成绩服从均值为85，标准差为5的正态分布。

注：你可以改变重复次数、每组样本量以及不同实验处理中的均值与标准差来探索不一样的结果。

# 模拟F检验基本步骤

第一步：从三个正态分布中分别抽取三个$n = 30$的样本；

第二步：对三组数据进行*F*检验，得到$F$和$p$值。

第三步：重复第一步和第二步1000次，记录下每次重复中的*p*和*F*值。

第四步：统计*F*值与*p*值的频率分布。

# 代码

```{r}
#载入包
if (!requireNamespace("pacman", quietly = TRUE)) {
  install.packages("pacman") }   # install pacman if not installed yet, it will be used for loading packages

pacman::p_load('tidyverse','bruceR','patchwork','ggdist','stats', "apaTables")
```

```{r}
# 创建数据框
df <- data.frame(matrix(nrow = 30 * 3, ncol = 2)) %>%
  dplyr::rename("values" = 1,
                "groups" = 2) %>%
  dplyr::mutate(groups = rep(1:3, each = 30),
                groups = as.factor(groups)) %>%
  dplyr::group_by(groups) %>%
  dplyr::mutate(values = case_when(
    groups == 1 ~ rnorm(30, mean = 60, sd = 12),
    groups == 2 ~ rnorm(30, mean = 65, sd = 12),
    groups == 3 ~ rnorm(30, mean = 70, sd = 12)
  )) %>%
  dplyr::ungroup()

df %>% dplyr::group_by(groups) %>%
      dplyr::summarise(mean = mean(values),
                       sd = sd(values))
   
sim_anova1 <- function(n = 30, group = 3, N_rep = 1000){
      
      Res <- data.frame(matrix(nrow = N_rep, ncol = 3)) %>%
            dplyr::rename("iter" = 1,
                          "F_val" = 2,
                          "p_val" = 3) 
      
      for (iter in 1:nrow(Res)) {

            tmpdf <- data.frame(matrix(nrow = 30 * 3, ncol = 2)) %>%
              dplyr::rename("values" = 1,
                          "groups" = 2) %>%
              dplyr::mutate(groups = rep(1:3, each = 30),
              groups = as.factor(groups)) %>%
              dplyr::group_by(groups) %>%
              dplyr::mutate(values = case_when(
                groups == 1 ~ rnorm(30, mean = 60, sd = 12),
                groups == 2 ~ rnorm(30, mean = 65, sd = 12),
                groups == 3 ~ rnorm(30, mean = 70, sd =12 )
              )) %>%
              dplyr::ungroup()
            
            # tmpRes <- bruceR::MANOVA(tmpdf, dv = "values", between = "groups")  
            tmpRes <- summary(aov(values ~ groups, data = tmpdf))
                  
            Res$iter[iter] <- iter
            # Res$F_val[iter] <- tmpRes$anova_table$F
            Res$F_val[iter] <- tmpRes[[1]]$`F value`[1]
            # Res$p_val[iter] <- tmpRes$anova_table$`Pr(>F)`
            Res$p_val[iter] <- tmpRes[[1]]$`Pr(>F)`[1]
            
      }
      return(Res)
}

# 运行上述的函数
sim1 <- sim_anova1()
#sim1
```

# 可视化F检验模拟结果
```{r}
p1 <- ggplot(sim1, aes(# x=iter,
                 x=F_val))+
      geom_histogram()+
      papaja::theme_apa()

p2 <- ggplot(sim1, aes(# x=iter,
                 x=p_val))+
      geom_histogram() +
      geom_vline(xintercept = 0.05, linetype = "dashed", color = "red") +
      papaja::theme_apa()

p1 + p2

print(paste('p值<=0.05的占比为', nrow(sim1[sim1$p_val<=0.05,])/nrow(sim1)))
```
# 模拟t检验基本步骤

第一步：从三个正态分布中分别抽取三个$n = 30$的样本；

第二步：对三组数据进行*t*检验，得到$t$和$p$值。

第三步：重复第一步和第二步1000次，记录下每次重复中的*p*和*t*值,并计算最小p <= 0.05的比率。

第四步：统计*t*值与*p*值的频率分布。

# 模拟t检验代码
```{r}
# simulation

sim_ttest <- function(n = 30, group = 3, N_rep = 1000){
      
      Res <- data.frame(matrix(nrow = N_rep, ncol = 7)) %>%
            dplyr::rename("iter" = 1,
                          "t_val1" = 2,
                          "p_val1" = 3,
                          "t_val2" = 4,
                          "p_val2" = 5,
                          "t_val3" = 6,
                          "p_val3" = 7,
                          ) 
      
      for (iter in 1:nrow(Res)) {
            
            tmpdf <- data.frame(matrix(nrow = 30 * 3, ncol = 2)) %>%
                dplyr::rename("values" = 1,
                          "groups" = 2) %>%
                dplyr::mutate(groups = rep(1:3, each = 30),
                groups = as.factor(groups)) %>%
                dplyr::group_by(groups) %>%
                dplyr::mutate(values = case_when(
                    groups == 1 ~ rnorm(30, mean = 60, sd = 12),
                    groups == 2 ~ rnorm(30, mean = 65, sd = 12),
                    groups == 3 ~ rnorm(30, mean = 70, sd = 12)
                )) %>%
                dplyr::ungroup()
            
            tmpRes1 <- t.test(values~groups,data = tmpdf[tmpdf$groups!=1,])
            tmpRes2 <- t.test(values~groups,data = tmpdf[tmpdf$groups!=2,])
            tmpRes3 <- t.test(values~groups,data = tmpdf[tmpdf$groups!=3,])
      
            Res$iter[iter] <- iter
            Res$t_val1[iter] <- tmpRes1$`statistic`
            Res$p_val1[iter] <- tmpRes1$`p.value`
            Res$t_val2[iter] <- tmpRes2$`statistic`
            Res$p_val2[iter] <- tmpRes2$`p.value`
            Res$t_val3[iter] <- tmpRes3$`statistic`
            Res$p_val3[iter] <- tmpRes3$`p.value`
            
      }
      return(Res)
}

# 运行上述的函数
sim2 <- sim_ttest()

# sim2

sim2 <- sim2 %>%
      dplyr::rowwise() %>%
      dplyr::mutate(min_p = min(p_val1, p_val2, p_val3))

```

# 可视化t检验代码
```{r}
p3 <- ggplot(sim2, aes(# x=iter,
                 x=min_p))+
  geom_histogram()+
  papaja::theme_apa()

p4 <- ggplot(sim2, aes(# x=iter,
                 x=min_p))+
  geom_histogram()+
  geom_vline(xintercept = 0.05, linetype = "dashed", color="red")+
  papaja::theme_apa()

p2+p4

print(paste('p值<=0.05的占比为',nrow(sim2[sim2$min_p<=0.05,])/nrow(sim2)))
```

