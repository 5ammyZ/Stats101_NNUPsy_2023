---
format: 
  revealjs:
    slide-number: true
    logo: images/image-393370223.png
    scrollable: true 
    theme: theme.scss
editor: visual
fontsize: 24pt
---

</br></br>

<h1 style="text-align: center">

3 Within-Subject ANOVA

</h1>

<h2 style="text-align: center">

</h2>

</br></br>

<h3 style="text-align: center">

Hu Chuan-Peng

</h3>

<h3 style="text-align: center">

2023-09-19

</h3>

</br></br>

# 本次课内容

-   单因素随机区组设计

-   单因素重复测量设计

-   工作流程(workflow)

# 复习

------------------------------------------------------------------------

## 单因素完全随机设计的数据模式</br><br>

| a~1~  | a~2~  | a~3~  | a~4~  |
|:-----:|:-----:|:-----:|:-----:|
| S~1~  | S~2~  | S~3~  | S~4~  |
| S~5~  | S~6~  | S~7~  | S~8~  |
| S~9~  | S~10~ | S~11~ | S~12~ |
| S~13~ | S~14~ | S~15~ | S~16~ |

------------------------------------------------------------------------

## 单因素完全随机设计的平方和与自由度分解</br><br>

![](images\image-2.jpg){fig-align="center"}

------------------------------------------------------------------------

## 平方和的计算过程</br><br>

$$总平方和:SS_{T}=\sum\sum x^2-\frac{(\sum \sum x)^2}{nk}$$

$$组内平方和:SS_{W}=\sum \frac{(\sum x)^2}{n}-\frac{(\sum \sum x)^2}{nk}$$

$$组间平方和:SS_{B}=SS_{T}-SS_{W}=\sum \sum x^2 - \sum \frac{(\sum x)^2}{n}$$
注：具体的公式推导可以参考课本




------------------------------------------------------------------------

## 单因素完全随机设计的方差分析表</br><br>

|              |            |            |                          |                   |
|:-------------:|:-------------:|:-------------:|:------------------------------:|:------------------------:|
| **变异来源** | **平方和** | **自由度** |         **均方**         |       **F**       |
|   组间变异   |  SS~组间~  |    p-1     |  MS~组间~=SS~组间~/p-1   | MS~组间~/MS~组内~ |
|   组内变异   |  SS~组内~  |   p(n-1)   | MS~组内~=SS~组内~/p(n-1) |                   |
|     总和     | SS~总变异~ |    np-1    |                          |                   |

------------------------------------------------------------------------

## 两因素完全随机设计的数据模式 </br></br>

|   a~1~   |   a~1~   |   a~1~   |   a~2~   |   a~2~   |   a~2~   |
|:--------:|:--------:|:--------:|:--------:|:--------:|:--------:|
| **b~1~** | **b~2~** | **b~3~** | **b~1~** | **b~2~** | **b~3~** |
|   S~1~   |   S~2~   |   S~3~   |   S~4~   |   S~5~   |   S~6~   |
|   S~7~   |   S~8~   |   S~9~   |  S~10~   |  S~11~   |  S~12~   |
|  S~13~   |  S~14~   |  S~15~   |  S~16~   |  S~17~   |  S~18~   |
|  S~19~   |  S~20~   |  S~21~   |  S~22~   |  S~23~   |  S~24~   |

------------------------------------------------------------------------

## 两因素完全随机设计的平方和与自由度分解 </br></br>

![](images\image-10.png){fig-align="center"}

------------------------------------------------------------------------

## 平方和的计算过程 </br></br>

$$SS_{A} = n \sum^k_{j=1}(\bar{X_j}-\bar{X_t})^2, A因素的组间平方和是假定全体只根据A因素来分组$$




$$SS_{B} = n \sum^k_{j=1}(\bar{X_j}-\bar{X_t})^2, B因素的组间平方和是假定全体只根据B因素来分组 $$
$$SS_{A*B}=SS_b-SS_A-SS_B$$




------------------------------------------------------------------------

## 两因素完全随机设计的方差分析表 </br>

|              |            |            |                           |                 |
|:-------------:|:-------------:|:-------------:|:-------------------------------------:|:--------------------:|
| **变异来源** | **平方和** | **自由度** |         **均方**          |      **F**      |
|   组间变异   |  SS~组间~  |    pq-1    |                           |                 |
|              |   SS~A~    |    p-1     |      MS~A~=SS~A~/p-1      | MS~A~/MS~组内~  |
|              |   SS~B~    |    q-1     |      MS~B~=SS~B~/q-1      | MS~B~/MS~组内~  |
|              |   SS~AB~   | (p-1)(q-1) | MS~AB~=SS~AB~/(p-1)(q-1)  | MS~AB~/MS~组内~ |
|   组内变异   |  SS~组内~  |  pq(n-1)   | MS~组内~=SS~组内~/pq(n-1) |                 |
|     总和     | SS~总变异~ |   npq-1    |                           |                 |



------------------------------------------------------------------------

## 单因素完全随机设计 

```{r}
# load package
# if 'pacman' is not exist, this package can be installed
if (!require('pacman')) {install.packages('pacman')}
# the package 'pacman' can use 'p_load' to load existed package or install package
library(pacman)
pacman::p_load('tidyverse', # this package used to preprocess the raw data
               'here', # this package can set the working directory as the root directory the script exist
               'bruceR', # do anova
               'papaja') # this package can create the manuscripts to APA.
```
研究者想要研究在不同天气下居民主观幸福感，数据见example2.2

调用bruceR直接计算结果如下：

```{r echo=TRUE}
# 读取数据，并修改数据类型
df <- read.csv('data/example2.2.csv')%>%
  mutate(subject=as.factor(subject),
         region=as.factor(region),
         gender=as.factor(gender))
# between subject anova
bruceR::MANOVA(df, dv="variable", between = c("region"))
#aov(variable~region,data=df)
```

------------------------------------------------------------------------

## 数据模式

|   r~1~   |   r~2~   |   r~3~   |
|:--------:|:--------:|:--------:|
| S~1~ | S~2~ | S~3~ |
| S~4~ | S~5~ | S~6~ |
| S~7~ | S~8~ | S~9~ |



------------------------------------------------------------------------

## 如何进行方差分析

1.计算平均值

2.计算不同来源的变异

3.计算自由度

4.计算均方

5.计算F值

------------------------------------------------------------------------

## 

第一步：计算平均值

$$总平均数：\bar{x_{t}} = \frac{\sum x_{ij}}{np},p为实验处理数，n为实验处理下每组人数$$

$$各实验处理平均数：\bar{x_{j}} = \frac{\sum x_{ij}}{n},i为组内编号，j为实验处理编号$$

```{r echo=TRUE}
mu <- mean(as.matrix(df['variable'])) # 总平均值
r1 <- mean(as.matrix(df[df['region']==1,'variable'])) # region1的平均值
r2 <- mean(as.matrix(df[df['region']==2,'variable'])) # region2的平均值
r3 <- mean(as.matrix(df[df['region']==3,'variable'])) # region3的平均值
```



------------------------------------------------------------------------

## 

第二步：计算不同来源的变异

$$总变异：SS = \sum (x - \bar{x_{ij}})^2$$

$$实验处理变异：SS_b = n \sum (\bar{x_j}-\bar{x_t})^2$$
$$组内变异：SS_w = p \sum (x - \bar{x_j})^2$$

$$残差：SS_e = SS - SS_b$$



```{r echo=TRUE}
# 计算总平方和
ss <- sum((as.matrix(df['variable'])-mu)**2)
ss
# 计算实验处理的平方和
ss.r.t<-((r1 - mu)**2+
         (r2 - mu)**2+
         (r3 - mu)**2)*20
ss.r.t
# 计算残差（组内变异）
# 组内变异
ss.r <- sum((df[df['region']==1,'variable']-r1)**2+
            (df[df['region']==2,'variable']-r2)**2+
            (df[df['region']==3,'variable']-r3)**2)
ss.r
# 残差
ss.e <- ss - ss.r.t
ss.e
```


------------------------------------------------------------------------

## 

第三步：计算自由度

$$总自由度：df = np-1$$

$$实验处理自由度：df_b = p - 1$$
$$组内变异自由度：df_w = p(n-1)$$

$$残差自由度：df_e = df - df_b$$
```{r echo=TRUE}
# 总自由度
df.t <- 3*20 - 1 
df.t
# 实验处理自由度
df.b <- 2 
df.b
# 组内变异自由度
df.w <- 3*(20-1)
df.w
# 残差自由度
df.e <- df.t - df.b
df.e
```




------------------------------------------------------------------------

## 

第四步：计算均方

$$实验处理均方：MS_b =\frac{SS_b}{df_b}$$
$$残差均方：MS_e =\frac{SS_e}{df_e}$$


```{r echo=TRUE}
# 计算实验处理均方
ms.r <- ss.r/df.w
ms.r
# 计算残差均方
ms.r.t <- ss.r.t/df.b
ms.r.t
```


------------------------------------------------------------------------

## 

第五步：计算F值

$$F=\frac{实验处理均方}{残差均方}=\frac{MS_b}{MS_e} =\frac{\frac{SS_b}{df_b}}{\frac{SS_e}{df_e}}$$

```{r echo=TRUE}
f <- ms.r.t/ms.r
f
```


------------------------------------------------------------------------

## 两因素完全随机设计 

研究者想要研究在不同天气下不同性别的居民主观幸福感，数据见example2.2

调用bruceR直接计算结果如下：

```{r}
df <- read.csv('data/example2.2.csv')%>%
  mutate(subject=as.factor(subject),
         region=as.factor(region),
         gender=as.factor(gender))
bruceR::MANOVA(df, dv="variable", between = c("region", "gender"))
#aov(variable~region*gender,data=df)
```

------------------------------------------------------------------------

## 数据模式


|   g~1~   |   g~1~   |   g~1~   |   g~2~   |   g~2~   |   g~2~   |
|:--------:|:--------:|:--------:|:--------:|:--------:|:--------:|
| **r~1~** | **r~2~** | **r~3~** | **r~1~** | **r~2~** | **r~3~** |
|   S~1~   |   S~2~   |   S~3~   |   S~4~   |   S~5~   |   S~6~   |
|   S~7~   |   S~8~   |   S~9~   |  S~10~   |  S~11~   |  S~12~   |
|  S~13~   |  S~14~   |  S~15~   |  S~16~   |  S~17~   |  S~18~   |
|  S~19~   |  S~20~   |  S~21~   |  S~22~   |  S~23~   |  S~24~   |

------------------------------------------------------------------------

## 





第一步：计算平均值

$$总平均数：\bar{x_{t}} = \frac{\sum x_{ij}}{npq},p为a因素水平数，q为b因素水平数，n为各实验处理下每组人数$$

$$a因素各水平平均数：\bar{x_{j}} = \frac{\sum^p x_{ij}}{nq},j为a因素各水平$$
$$b因素各水平平均数：\bar{x_{j}} = \frac{\sum^qx_{ij}}{np},j为b因素各水平$$

$$ab因素组合后各条件平均数：\bar{x_{j}} = \frac{\sum^{pq}x_{ij}}{n},j为ab因素组合后各条件$$


```{r echo=TRUE}
mu <- mean(as.matrix(df['variable'])) # 总平均值
# 只考虑单一因素的分组的平均值
r1 <- mean(as.matrix(df[df['region']==1,'variable'])) # r1的平均值
r2 <- mean(as.matrix(df[df['region']==2,'variable'])) # r2的平均值
r3 <- mean(as.matrix(df[df['region']==3,'variable'])) # r3的平均值
g1 <- mean(as.matrix(df[df['gender']==1,'variable'])) # g1的平均值
g2 <- mean(as.matrix(df[df['gender']==2,'variable'])) # g2的平均值
# 考虑两因素的分组的平均值
r1g1 <- mean(as.matrix(df[(df['region']==1)&(df['gender']==1),'variable'])) # r1g1的平均值
r2g1 <- mean(as.matrix(df[(df['region']==2)&(df['gender']==1),'variable'])) # r2g1的平均值
r3g1 <- mean(as.matrix(df[(df['region']==3)&(df['gender']==1),'variable'])) # r3g1的平均值
r1g2 <- mean(as.matrix(df[(df['region']==1)&(df['gender']==2),'variable'])) # r1g2的平均值
r2g2 <- mean(as.matrix(df[(df['region']==2)&(df['gender']==2),'variable'])) # r2g2的平均值
r3g2 <- mean(as.matrix(df[(df['region']==3)&(df['gender']==2),'variable'])) # r3g2的平均值
```



------------------------------------------------------------------------

## 

第二步：计算不同来源的变异

$$总变异：SS = \sum (x - \bar{x_{ij}})^2$$

$$实验处理变异：SS_b = n \sum (\bar{x_j}-\bar{x_t})^2,j为ab因素组合后各条件$$


$$a因素主效应引起的变异：SS_A = nq \sum (\bar{x_j}-\bar{x_t})^2,j为a因素各水平$$

$$b因素主效应引起的变异：SS_B = np \sum (\bar{x_j}-\bar{x_t})^2,j为b因素各水平$$

$$ab因素的交互效应引起的变异：SS_AB = SS_b - SS_A - SS_B$$




$$组内变异：SS_w = pq \sum (x - \bar{x_j})^2, j为ab因素组合后各条件$$

$$残差：SS_e = SS - SS_b$$



```{r echo=TRUE}
# 总变异
ss <- sum((as.matrix(df['variable'])-mu)**2)
ss
# 实验处理变异
ss.r.g.t <- ((r1g1 - mu)**2+
            (r2g1 - mu)**2+
            (r3g1 - mu)**2+
            (r1g2 - mu)**2+
            (r2g2 - mu)**2+
            (r3g2 - mu)**2)*10
ss.r.g.t
# region主效应变异
ss.r.t <- ((r1 - mu)**2+
         (r2 - mu)**2+
         (r3 - mu)**2)*20
ss.r.t
# gender主效应变异
ss.g.t <- ((g1 - mu)**2+
         (g2 - mu)**2)*30
ss.g.t
# region和gender交互效应变异
ss.rg.t <- ss.r.g.t - ss.r.t - ss.g.t
ss.rg.t
# 组内变异
ss.rg <- sum((df[(df['region']==1)&(df['gender']==1),'variable']-r1g1)**2+
             (df[(df['region']==2)&(df['gender']==1),'variable']-r2g1)**2+
             (df[(df['region']==3)&(df['gender']==1),'variable']-r3g1)**2+
             (df[(df['region']==1)&(df['gender']==2),'variable']-r1g2)**2+
             (df[(df['region']==2)&(df['gender']==2),'variable']-r2g2)**2+
             (df[(df['region']==3)&(df['gender']==2),'variable']-r3g2)**2)
ss.rg
# 残差
ss.e <- ss - ss.r.g.t
ss.e
```


------------------------------------------------------------------------

## 

第三步：计算自由度

$$总自由度：df = npq-1$$

$$实验处理自由度：df_b = pq - 1$$
$$a因素主效应自由度：df_A = p-1$$
$$b因素主效应自由度：df_B = q-1$$
$$ab因素交互效应自由度：df_{AB} = (p-1)(q-1)$$




$$组内变异自由度：df_w = pq(n-1)$$

$$残差自由度：df_e = df - df_b$$
```{r echo=TRUE}
# 总自由度
df.t <- 3*2*10 - 1 
df.t
# 实验处理自由度
df.r.g <- 3*2 -1  
df.r.g
# region主效应自由度
df.r <- 3 -1
df.r
# gender主效应自由度
df.g <- 2 -1
df.g
# region和gender交互效应自由度
df.rg <- (3 -1)*(2-1)
df.rg
# 组内变异自由度
df.w <- 3*2*(10-1)
df.w
# 残差自由度
df.e <- df.t - df.r.g
df.e
```




------------------------------------------------------------------------

## 

第四步：计算均方

$$a因素主效应均方：MS_A =\frac{SS_A}{df_A}$$

$$b因素主效应均方：MS_B =\frac{SS_B}{df_B}$$
$$ab因素交互效应均方：MS_AB =\frac{SS_AB}{df_AB}$$





$$残差均方：MS_e =\frac{SS_e}{df_e}$$


```{r echo=TRUE}
# region主效应均方
ms.r <- ss.r.t/df.r
ms.r
# gender主效应均方
ms.g <- ss.g.t/df.g
ms.g
# region和gender交互效应均方
ms.rg <- ss.rg.t/df.rg
ms.rg
# 计算残差均方
ms.e <- ss.e/df.e
ms.e
```


------------------------------------------------------------------------

## 

第五步：计算F值

$$a因素主效应的F值：F=\frac{a因素主效应均方}{残差均方}=\frac{MS_A}{MS_e} =\frac{\frac{SS_A}{df_A}}{\frac{SS_e}{df_e}}$$
$$b因素主效应的F值：F=\frac{b因素主效应均方}{残差均方}=\frac{MS_B}{MS_e} =\frac{\frac{SS_B}{df_B}}{\frac{SS_e}{df_e}}$$
$$ab因素交互效应的F值：F=\frac{ab因素交互效应均方}{残差均方}=\frac{MS_{AB}}{MS_e} =\frac{\frac{SS_{AB}}{df_{AB}}}{\frac{SS_e}{df_e}}$$


```{r echo=TRUE}
# region主效应F值
f.r <- ms.r/ms.e
f.r
# gender主效应F值
f.g <- ms.g/ms.e
f.g
# region和gender交互效应F值
f.rg <- ms.rg/ms.e
f.rg

```





```{r echo=TRUE}




ss.rg.t <- ss.r.g.t - ss.g.t - ss.r.t
ms.g.t <- ss.rg.t
ms.r.t <- ss.rg.t
ms.rg.t <- ss.rg.t
  
ss.e <- ss - ss.r.g.t

```









------------------------------------------------------------------------

## 方差分析的适用条件</br></br>

1.  独立随机抽样</br></br>

2.  正态分布</br></br>

3.  方差齐性</br></br>

------------------------------------------------------------------------

## 方差分析的workflow</br>

1.描述统计

-   数据可视化图表（数据分布趋势，形态）；

2.统计前提检验

-   正态性检验

-   同质性/方差齐性检验；

3.方差分析

-   根据主效应，交互效应是否显著，选择简单效应检验或者事后多次比较，得到统计结果；

4.结论

------------------------------------------------------------------------

# 单因素随机区组设计

------------------------------------------------------------------------

## 单因素随机区组设计

</br>

1.心理学研究中，被试的个体差异是误差变异的重要来源。它常常会混淆实验处理的效应，因此是无关变异。</br>

2.随机区组设计使用区组方法减小误差变异，即用区组方法分离出由无关变量引起的变异，使它不出现在处理效应和误差变异中。达到区组内被试同质，组间异质</br>

3.单因素随机区组设计适用于这样的情景：研究中有一个自变量，自变量有两个或多个水平（$p \ge 2$），研究中还有一个无关变量，也有两个或多个水平（$n \ge 2$），并且自变量的水平与无关变量的水平之间没有交互作用。</br>

4.当无关变量是被试变量时，一般首先将被试在这个无关变量上进行匹配，然后将他们随机分配给不同的实验处理。

------------------------------------------------------------------------

## 假设检验

（1）处理水平的总体平均数相等

$$ H_0: \mu_1 = \mu_2 = \mu_3 = ... = \mu_p$$

（2）区组的总体平均数相等

$$ H_0: \mu_1 = \mu_2 = \mu_3 = ... = \mu_n$$

## 完全随机设计的变异示意图

![](images/1694502906066.jpg){fig-align="center"}

------------------------------------------------------------------------

## 随机区组设计的变异示意图

![](images/1694503007449.jpg){fig-align="center"}

------------------------------------------------------------------------

## 随机区组设计的数据模式

|       | a~1~  | a~2~  | a~3~  | a~4~  |
|:-----:|:-----:|:-----:|:-----:|:-----:|
| 区组1 | S~11~ | S~12~ | S~13~ | S~14~ |
| 区组2 | S~21~ | S~22~ | S~23~ | S~24~ |
| 区组3 | S~31~ | S~32~ | S~33~ | S~34~ |
| 区组4 | S~41~ | S~42~ | S~43~ | S~44~ |

------------------------------------------------------------------------

## 随机区组设计的平方和与自由度分解

![](images/1694510350924.jpg){fig-align="center"}

------------------------------------------------------------------------

## 随机区组设计的方差分析表 </br>

|              |            |            |                                    |                   |
|:-------------:|:-------------:|:-------------:|:-------------:|:-------------:|
| **变异来源** | **平方和** | **自由度** |              **均方**              |       **F**       |
|   组间变异   |  SS~组间~  |    p-1     |     MS~组间~=SS~组间~/(p - 1)      | MS~组间~/MS~残差~ |
|   组内变异   |  SS~组内~  |   p(n-1)   |    MS~组内~ = SS~组内~/p(n - 1)    |                   |
|   区组变异   |  SS~区组~  |    n-1     |    MS~区组~ = SS~区组~/ (n - 1)    | MS~区组~/MS~残差~ |
|     残差     |  SS~残差~  | (p-1)(n-1) | MS~残差~ = SS~残差~/(p -1)( n - 1) |                   |
|     总和     | SS~总变异~ |    np-1    |                                    |                   |

------------------------------------------------------------------------

## 随机区组设计的平方和的计算

</br>

$$SS_{总变异} = SS_{组间}+SS_{组内}$$

$$SS_{总变异} = SS_{组间}+(SS_{区组}+SS_{残差})$$

$$SS_{残差} = SS_{总变异}-SS_{组间}-SS_{区组}$$

$$具体公式推导请见邓铸《心理统计学与SPSS应用》$$

------------------------------------------------------------------------

## 

$$SS_{总变异} = SS_{组间}+SS_{组内}(完全随机设计)$$

$$SS_{总变异} = SS_{组间}+(SS_{区组}+SS_{残差})(随机区组设计)$$

$$SS_{残差} = SS_{总变异}-SS_{组间}-SS_{区组}$$

$$具体公式推导请见邓铸《心理统计学与SPSS应用》$$

------------------------------------------------------------------------

## 

总平方和：$SS_{T} = \sum \sum x^2 - \frac{(\sum \sum x)^2}{nk}$

组间平方和：$SS_{B} = \sum \frac{(\sum x)^2}{n} - \frac{(\sum \sum x)^2}{nk}$

区组平方和：$SS_{R} = \sum \frac{\sum x}{k} - \frac{(\sum \sum x)^2}{nk}$

------------------------------------------------------------------------

## 

研究者想要研究在人们在不同天气情况下的主观幸福感，将按照地区将被试分为8个区组，然后随机测量每个区组内的4个同质被试在相应天气下的主观幸福感。 (尝试手算)

------------------------------------------------------------------------




```{r}
df <- data.frame(weather1 = c(3,6,4,3,5,7,5,2),
                 weather2 = c(4,6,4,2,4,5,3,3),
                 weather3 = c(8,9,8,7,5,6,7,6),
                 weather4 = c(9,8,8,7,12,13,12,11),
                 region = as.factor(rep(1:2,each=4)))%>%
  rename('w1'=1,
         'w2'=2,
         'w3'=3,
         'w4'=4)
bruceR::MANOVA(df,dvs=c("w1", "w2", "w3", "w4"), dvs.pattern="w(.)",
               within = 'w',
       between = "region")
```


```{r}
# calculate the average 
# calculate the average of all data
mu <- mean(as.matrix(df[,c('w1','w2','w3','w4')])) 
# calculate the average of each weather
w1 <- mean(df[,'w1'])
w2 <- mean(df[,'w2'])
w3 <- mean(df[,'w3'])
w4 <- mean(df[,'w4'])
# calculate the average of each region
r1 <- mean(as.matrix(df[df['region']==1,c('w1','w2','w3','w4')]))
r2 <- mean(as.matrix(df[df['region']==2,c('w1','w2','w3','w4')]))
# calculate the average of each weather and region
w1r1<- mean(as.matrix(df[df['region']==1,'w1']))
w2r1<- mean(as.matrix(df[df['region']==1,'w2']))
w3r1<- mean(as.matrix(df[df['region']==1,'w3']))
w4r1<- mean(as.matrix(df[df['region']==1,'w4']))
w1r2<- mean(as.matrix(df[df['region']==2,'w1']))
w2r2<- mean(as.matrix(df[df['region']==2,'w2']))
w3r2<- mean(as.matrix(df[df['region']==2,'w3']))
w4r2<- mean(as.matrix(df[df['region']==2,'w4']))
# calculate the sum square 
# calculate sum square of all data
ss.T <- sum((as.matrix(df[,c('w1','w2','w3','w4')]) - mu)**2)
# calculate sum square of each weather 
ss.w1 <- sum((df[,'w1']-w1)**2)
ss.w2 <- sum((df[,'w2']-w2)**2)
ss.w3 <- sum((df[,'w3']-w3)**2)
ss.w4 <- sum((df[,'w4']-w4)**2)
ss.w <- sum(ss.w1+ss.w2+ss.w3+ss.w4)
# calculate sum square of each weather 
ss.r1 <- sum((as.matrix(df[df['region']==1,c('w1','w2','w3','w4')])-r1)**2)
ss.r2 <- sum((as.matrix(df[df['region']==2,c('w1','w2','w3','w4')])-r2)**2)
ss.r <- sum(ss.r1+ss.r2)
# calculate sum square of each weather and region
ss.w1r1 <- sum((as.matrix(df[df['region']==1,'w1'])-w1r1)**2)
ss.w2r1 <- sum((as.matrix(df[df['region']==1,'w2'])-w2r1)**2)
ss.w3r1 <- sum((as.matrix(df[df['region']==1,'w3'])-w3r1)**2)
ss.w4r1 <- sum((as.matrix(df[df['region']==1,'w4'])-w4r1)**2)
ss.w1r2 <- sum((as.matrix(df[df['region']==2,'w1'])-w1r2)**2)
ss.w2r2 <- sum((as.matrix(df[df['region']==2,'w2'])-w2r2)**2)
ss.w3r2 <- sum((as.matrix(df[df['region']==2,'w3'])-w3r2)**2)
ss.w4r2 <- sum((as.matrix(df[df['region']==2,'w4'])-w4r2)**2)
ss.wr <- sum(ss.w1r1+
             ss.w2r1+
             ss.w3r1+
             ss.w4r1+
             ss.w1r2+
             ss.w2r2+
             ss.w3r2+
             ss.w4r2)
ss.r.wr <- sum((w1r1-r1)**2+
               (w2r1-r1)**2+
               (w3r1-r1)**2+
               (w4r1-r1)**2+
               (w1r2-r2)**2+
               (w2r2-r2)**2+
               (w3r2-r2)**2+
               (w4r2-r2)**2)*4
ss.w.wr <- sum((w1r1-w1)**2+
               (w2r1-w2)**2+
               (w3r1-w3)**2+
               (w4r1-w4)**2+
               (w1r2-w1)**2+
               (w2r2-w2)**2+
               (w3r2-w3)**2+
               (w4r2-w4)**2)*4
ss.wr.t <- sum((w1r1-mu)**2+
               (w2r1-mu)**2+
               (w3r1-mu)**2+
               (w4r1-mu)**2+
               (w1r2-mu)**2+
               (w2r2-mu)**2+
               (w3r2-mu)**2+
               (w4r2-mu)**2)*4



```

------------------------------------------------------------------------

## 随机区组设计的优点

1.从总变异中分离了一个无关变量的效应，从而减小了实验误差，可获得对处理效应的更加精确的估计；

2.随机区组设计可使用于含任何处理水平数的实验中，并且区组的数量也不受限制，因而有较好的灵活性。



------------------------------------------------------------------------

## 随机区组设计的缺点

1.如实验中含有许多处理水平，可能给形成同质区组，寻找同质被试带来困难；

2.使用随机区组设计比使用完全随机设计有更多的限定，例如，使用随机区组实验设计的前提假设是，实验中的自变量与无关变量之间没有交互作用。如果交互作用是存在的，使用随机区组实验设计是不合适的。

------------------------------------------------------------------------

# 单因素重复测量设计

------------------------------------------------------------------------

## 单因素重复测量设计

1.实验中测量误差引起的变异和未控制的无关变量引起的变异是组内变异的组成部分。其中主要是被试个体差异带来的变异。减少误差变异的一个方法就是控制个体差异引起的无关变异，一个有效的方法就是随机区组设计，而更有效的方法是重复测量实验设计。

------------------------------------------------------------------------

## 

2.重复测量设计的基本方法是：实验中每个被试接受所有的处理水平。这种实验设计的目的是利用被试自己做控制，使被试的各方面特点在所有的处理中保持恒定，以最大限度地控制由被试的个体差异带来的变异。

------------------------------------------------------------------------

## 

3.使用重复测量设计地前提是研究者必须事先假设，当若干处理水平连续实施给同一被试时，被试接受前面的处理对接受后面地处理没有长期影响。当处理地实施对被试有长期影响时，重复测量设计是不合适的。同时，重复测量设计中需要平衡顺序效应的问题。

------------------------------------------------------------------------

## 假设检验

处理水平的总体平均数相等

$$ H_0: \mu_1 = \mu_2 = \mu_3 = ... = \mu_p$$

------------------------------------------------------------------------

## 单因素重复测量设计的数据模式

|       | a~1~ | a~2~ | a~3~ | a~4~ |
|:-----:|:----:|:----:|:----:|:----:|
| 被试1 | S~1~ | S~1~ | S~1~ | S~1~ |
| 被试2 | S~2~ | S~2~ | S~2~ | S~2~ |
| 被试3 | S~3~ | S~3~ | S~3~ | S~3~ |
| 被试4 | S~4~ | S~4~ | S~4~ | S~4~ |

$$参考来源：舒华《心理与教育研究中的多因素实验设计》$$

------------------------------------------------------------------------

## 单因素重复测量设计的平方和与自由度分解

![](images/1694518294978.png){fig-align="center"}

------------------------------------------------------------------------

## 单因素重复测量设计的方差分析表 </br>

|              |              |            |                                      |                       |
|:-------------:|:-------------:|:-------------:|:-------------:|:-------------:|
| **变异来源** |  **平方和**  | **自由度** |               **均方**               |         **F**         |
|  被试间变异  |  SS~被试间~  |    n-1     |                                      |                       |
|  被试内变异  |  SS~被试内~  |   n(p-1)   |                                      |                       |
|   实验处理   | SS~实验处理~ |    p-1     | MS~实验处理~ = SS~实验处理~/ (p - 1) | MS~实验处理~/MS~残差~ |
|     残差     |   SS~残差~   | (n-1)(p-1) |  MS~残差~ = SS~残差~/(n -1)(p - 1)   |                       |
|     总和     |  SS~总变异~  |    np-1    |                                      |                       |

------------------------------------------------------------------------

## 随机区组设计的平方和的计算

$$SS_{总变异} = SS_{被试间}+SS_{被试内}$$

$$SS_{总变异} = SS_{被试间}+(SS_{实验处理}+SS_{残差})$$

$$SS_{残差} = SS_{总变异}-SS_{被试间}-SS_{实验处理}$$

## $$具体公式推导请见邓铸《心理统计学与SPSS应用》$$

## 

总平方和：$SS_{T} = \sum \sum x^2 - \frac{(\sum \sum x)^2}{nk}$

实验处理平方和：$SS = \sum \frac{(\sum x)^2}{n} - \frac{(\sum \sum x)^2}{nk}$

被试间平方和：$SS_{B} = \sum \frac{\sum x}{k} - \frac{(\sum \sum x)^2}{nk}$

------------------------------------------------------------------------

## 

研究者想要研究在人们在不同天气情况下的主观幸福感，选取8个被试，然后测量每个被试在相应天气下的主观幸福感。

------------------------------------------------------------------------

## 随机区组设计与重复测量设计的联系和区别

::: {layout-ncol="2"}
![](images/1694519954379.jpg)

![](images/1694519974681.jpg)
:::

------------------------------------------------------------------------

## 随机区组设计与重复测量设计的联系和区别

1.随机区组设计与重复测量设计在统计上是一样的

2.随机区组设计与重复测量设计在应用上有本质的差别：

-   在随机区组设计中，同一区组的每个受试对象都随机分配，接受不同的处理

-   而对于重复测量设计，通常是对同一受试对象在各时间点进行测量。

------------------------------------------------------------------------

## Fisher与随机区组实验设计

1.随机区组实验设计的思想来源于Fisher的农业研究

2.在农田进行大面积试验时，不可控因素很多，比如农田的质量。

3.不同品种的作物应该种植在土质相同的田中，因此按土质等因素把田分为一块一块的区域，每块区域中土质相同，这块区域被称为区组。

4.后来在农业以外的其他实验中，一直沿用区组这个概念。类似于这种的实验设计就叫做随机区组设计。

------------------------------------------------------------------------

## 基本预设

1.每个样本内的观测量之间必须独立

2.样本源自的总体必须是正态的

3.样本源自的总体方差必须相等(方差齐性)

4.协方差齐性：每位受试者在每个处理条件中的测量值保持独立

------------------------------------------------------------------------

## 协方差齐性检验

1.Mauchly球形检验 (Mauchly's sphericity test）

2.如果重复测量ANOVA所得p\<0.05(存在显著效应)时，必须考虑此检验

3.Mauchly球形检验对p值进行调整，以适应数据不符合协方差齐性假定的情况

------------------------------------------------------------------------

# 工作流程(workflow)

------------------------------------------------------------------------

## 

有研究者想要探究吃不同食物对个体主观幸福感的影响。探究选取8名被试，分别记录每一位被试食用不同食物时的主观幸福感。试探究食用不同食物是否对主观幸福感产生影响。（exp3.3.csv）

------------------------------------------------------------------------

## 描述统计

------------------------------------------------------------------------

## 正态性检验

------------------------------------------------------------------------

## 方差齐性检验

------------------------------------------------------------------------

## 协方差齐性检验

------------------------------------------------------------------------

## 方差分析

------------------------------------------------------------------------

## 事后比较

------------------------------------------------------------------------

## 总结

（1）单因素随机区组设计

（2）单因素重复测量设计

（3）工作流程(workflow)
